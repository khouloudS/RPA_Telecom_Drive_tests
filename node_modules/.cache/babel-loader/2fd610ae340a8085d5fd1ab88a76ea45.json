{"ast":null,"code":"\"use strict\";\n\nvar _slicedToArray = require(\"C:\\\\Users\\\\khouloud\\\\Documents\\\\PI\\\\MERN_Stack_PI\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/slicedToArray\");\n\nvar _regeneratorRuntime = require(\"C:\\\\Users\\\\khouloud\\\\Documents\\\\PI\\\\MERN_Stack_PI\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"C:\\\\Users\\\\khouloud\\\\Documents\\\\PI\\\\MERN_Stack_PI\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/asyncToGenerator\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst events_1 = require(\"events\");\n\nconst logger_1 = require(\"./logger\");\n\nclass RegistrationState {\n  constructor(token = '', notificationId = '', messageTypes = new Set()) {\n    this.token = token;\n    this.notificationId = notificationId;\n    this.messageTypes = messageTypes;\n  }\n\n  clone() {\n    return new RegistrationState(this.token, this.notificationId, new Set(this.messageTypes));\n  }\n\n}\n\nexports.RegistrationState = RegistrationState;\n\nfunction setDifference(a, b) {\n  return [...[...a].filter(x => !b.has(x)), ...[...b].filter(x => !a.has(x))];\n}\n\nfunction hasDifference(a, b) {\n  let reasons = new Set();\n\n  if (a.notificationId !== b.notificationId) {\n    reasons.add('notificationId');\n  }\n\n  if (a.token !== b.token) {\n    reasons.add('token');\n  }\n\n  if (setDifference(a.messageTypes, b.messageTypes).length > 0) {\n    reasons.add('messageType');\n  }\n\n  return [reasons.size > 0, reasons];\n}\n\nclass Connector extends events_1.EventEmitter {\n  constructor(config) {\n    super();\n    this.config = config;\n    this.desiredState = new RegistrationState();\n    this.currentState = new RegistrationState();\n    this.hasActiveAttempt = false;\n  }\n\n  subscribe(messageType) {\n    var _this = this;\n\n    return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            if (!_this.desiredState.messageTypes.has(messageType)) {\n              _context.next = 3;\n              break;\n            }\n\n            logger_1.log.debug('message type already registered ', messageType);\n            return _context.abrupt(\"return\");\n\n          case 3:\n            _this.desiredState.messageTypes.add(messageType);\n\n            _context.next = 6;\n            return _this.persistRegistration();\n\n          case 6:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee);\n    }))();\n  }\n\n  unsubscribe(messageType) {\n    var _this2 = this;\n\n    return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) switch (_context2.prev = _context2.next) {\n          case 0:\n            if (_this2.desiredState.messageTypes.has(messageType)) {\n              _context2.next = 2;\n              break;\n            }\n\n            return _context2.abrupt(\"return\");\n\n          case 2:\n            _this2.desiredState.messageTypes.delete(messageType);\n\n            _context2.next = 5;\n            return _this2.persistRegistration();\n\n          case 5:\n          case \"end\":\n            return _context2.stop();\n        }\n      }, _callee2);\n    }))();\n  }\n\n  updateToken(token) {\n    this.desiredState.token = token;\n    this.persistRegistration();\n  }\n\n  persistRegistration() {\n    var _this3 = this;\n\n    return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var _hasDifference, _hasDifference2, needToUpdate, reasons, stateToPersist, persistedState;\n\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) switch (_context3.prev = _context3.next) {\n          case 0:\n            if (!(!_this3.config.token || _this3.config.token.length === 0)) {\n              _context3.next = 3;\n              break;\n            }\n\n            logger_1.log.trace('Can\\'t persist registration: token is not set');\n            return _context3.abrupt(\"return\");\n\n          case 3:\n            if (!_this3.hasActiveAttempt) {\n              _context3.next = 6;\n              break;\n            }\n\n            logger_1.log.trace('One registration attempt is already in progress');\n            return _context3.abrupt(\"return\");\n\n          case 6:\n            _hasDifference = hasDifference(_this3.desiredState, _this3.currentState), _hasDifference2 = _slicedToArray(_hasDifference, 2), needToUpdate = _hasDifference2[0], reasons = _hasDifference2[1];\n\n            if (needToUpdate) {\n              _context3.next = 9;\n              break;\n            }\n\n            return _context3.abrupt(\"return\");\n\n          case 9:\n            if (!_this3.currentState.notificationId) {\n              reasons.delete('notificationId');\n            }\n\n            logger_1.log.trace('Persisting registration', reasons, _this3.desiredState);\n            _context3.prev = 11;\n            _this3.hasActiveAttempt = true;\n            stateToPersist = _this3.desiredState.clone();\n\n            if (!(stateToPersist.messageTypes.size > 0)) {\n              _context3.next = 24;\n              break;\n            }\n\n            _context3.next = 17;\n            return _this3.updateRegistration(stateToPersist, reasons);\n\n          case 17:\n            persistedState = _context3.sent;\n            _this3.currentState.token = persistedState.token;\n            _this3.currentState.notificationId = persistedState.notificationId;\n            _this3.currentState.messageTypes = persistedState.messageTypes;\n\n            _this3.emit('stateChanged', 'registered');\n\n            _context3.next = 30;\n            break;\n\n          case 24:\n            _context3.next = 26;\n            return _this3.removeRegistration();\n\n          case 26:\n            _this3.currentState.token = stateToPersist.token;\n            _this3.currentState.notificationId = stateToPersist.notificationId;\n\n            _this3.currentState.messageTypes.clear();\n\n            _this3.emit('stateChanged', 'unregistered');\n\n          case 30:\n            _context3.prev = 30;\n            _this3.hasActiveAttempt = false;\n            setTimeout(() => _this3.persistRegistration(), 0);\n            return _context3.finish(30);\n\n          case 34:\n          case \"end\":\n            return _context3.stop();\n        }\n      }, _callee3, null, [[11,, 30, 34]]);\n    }))();\n  }\n\n  setNotificationId(notificationId) {\n    this.desiredState.notificationId = notificationId;\n    this.persistRegistration();\n  }\n\n}\n\nexports.Connector = Connector;","map":{"version":3,"sources":["C:/Users/khouloud/Documents/PI/MERN_Stack_PI/node_modules/twilio-notifications/lib/connector.js"],"names":["Object","defineProperty","exports","value","events_1","require","logger_1","RegistrationState","constructor","token","notificationId","messageTypes","Set","clone","setDifference","a","b","filter","x","has","hasDifference","reasons","add","length","size","Connector","EventEmitter","config","desiredState","currentState","hasActiveAttempt","subscribe","messageType","log","debug","persistRegistration","unsubscribe","delete","updateToken","trace","needToUpdate","stateToPersist","updateRegistration","persistedState","emit","removeRegistration","clear","setTimeout","setNotificationId"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst events_1 = require(\"events\");\nconst logger_1 = require(\"./logger\");\nclass RegistrationState {\n    constructor(token = '', notificationId = '', messageTypes = new Set()) {\n        this.token = token;\n        this.notificationId = notificationId;\n        this.messageTypes = messageTypes;\n    }\n    clone() {\n        return new RegistrationState(this.token, this.notificationId, new Set(this.messageTypes));\n    }\n}\nexports.RegistrationState = RegistrationState;\nfunction setDifference(a, b) {\n    return [...[...a].filter(x => !b.has(x)),\n        ...[...b].filter(x => !a.has(x))];\n}\nfunction hasDifference(a, b) {\n    let reasons = new Set();\n    if (a.notificationId !== b.notificationId) {\n        reasons.add('notificationId');\n    }\n    if (a.token !== b.token) {\n        reasons.add('token');\n    }\n    if (setDifference(a.messageTypes, b.messageTypes).length > 0) {\n        reasons.add('messageType');\n    }\n    return [reasons.size > 0, reasons];\n}\nclass Connector extends events_1.EventEmitter {\n    constructor(config) {\n        super();\n        this.config = config;\n        this.desiredState = new RegistrationState();\n        this.currentState = new RegistrationState();\n        this.hasActiveAttempt = false;\n    }\n    async subscribe(messageType) {\n        if (this.desiredState.messageTypes.has(messageType)) {\n            logger_1.log.debug('message type already registered ', messageType);\n            return;\n        }\n        this.desiredState.messageTypes.add(messageType);\n        await this.persistRegistration();\n    }\n    async unsubscribe(messageType) {\n        if (!this.desiredState.messageTypes.has(messageType)) {\n            return;\n        }\n        this.desiredState.messageTypes.delete(messageType);\n        await this.persistRegistration();\n    }\n    updateToken(token) {\n        this.desiredState.token = token;\n        this.persistRegistration();\n    }\n    async persistRegistration() {\n        if (!this.config.token || this.config.token.length === 0) {\n            logger_1.log.trace('Can\\'t persist registration: token is not set');\n            return;\n        }\n        if (this.hasActiveAttempt) {\n            logger_1.log.trace('One registration attempt is already in progress');\n            return;\n        }\n        let [needToUpdate, reasons] = hasDifference(this.desiredState, this.currentState);\n        if (!needToUpdate) {\n            return;\n        }\n        if (!this.currentState.notificationId) {\n            reasons.delete('notificationId');\n        }\n        logger_1.log.trace('Persisting registration', reasons, this.desiredState);\n        try {\n            this.hasActiveAttempt = true;\n            let stateToPersist = this.desiredState.clone();\n            if (stateToPersist.messageTypes.size > 0) {\n                let persistedState = await this.updateRegistration(stateToPersist, reasons);\n                this.currentState.token = persistedState.token;\n                this.currentState.notificationId = persistedState.notificationId;\n                this.currentState.messageTypes = persistedState.messageTypes;\n                this.emit('stateChanged', 'registered');\n            }\n            else {\n                await this.removeRegistration();\n                this.currentState.token = stateToPersist.token;\n                this.currentState.notificationId = stateToPersist.notificationId;\n                this.currentState.messageTypes.clear();\n                this.emit('stateChanged', 'unregistered');\n            }\n        }\n        finally {\n            this.hasActiveAttempt = false;\n            setTimeout(() => this.persistRegistration(), 0);\n        }\n    }\n    setNotificationId(notificationId) {\n        this.desiredState.notificationId = notificationId;\n        this.persistRegistration();\n    }\n}\nexports.Connector = Connector;\n"]},"metadata":{},"sourceType":"script"}